select * from(select policynumber,count(id) as 'qtd' from (select distinct pp.policynumber, bi.idfrom bc_policyperiod pp inner join bc_invoiceitem ii on pp.id = ii.policyperiodidinner join bc_charge c on c.id = ii.chargeidinner join bc_billinginstruction bi on bi.id = c.billinginstructionidinner join  bcx_eventworkitem_gcs  ewi on ewi.BillingInstructionID = bi.id where ewi.event = 10010 and not exists(select 1 from bcx_eventworkitem_gcs ewi2 where ewi2.event = 10012 and ewi2.payload like '%' + ewi.RefNumber + '%')and bi.subtype = 1) agroup by policynumberhaving count(id) > 1) bwhere 1 = 1